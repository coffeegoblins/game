/**
 * @license RequireJS text 2.0.9 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

define("engine/game/viewport",[],function(){"use strict";function e(){}var t={border:0,centerTarget:!1,leadTarget:!1,isPercentageBased:!1,leadScale:1};return e.prototype.initialize=function(){this.scale=1,this.minScale=.25,this.maxScale=4,this.rect=new Rectangle(0,0,0,0),this.controllerStack=new LinkedList,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.tabIndex=0,document.body.firstChild?document.body.insertBefore(this.canvas,document.body.firstChild):document.body.appendChild(this.canvas),this.onResize(),window.addEventListener("resize",this.onResize.bind(this))},e.prototype.addController=function(e){var i=Utility.merge({},t,e);return this.controllerStack.addFirst(i),i},e.prototype.fromScreen=function(e,t){return new Vector2(this.rect.left+e/this.scale,this.rect.top+t/this.scale)},e.prototype.move=function(e,t){this.setPosition(this.rect.left+e,this.rect.top+t)},e.prototype.onResize=function(){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight;var e=Math.floor(this.canvas.width/this.scale),t=Math.floor(this.canvas.height/this.scale);this.rect.setSizeFromCenter(e,t)},e.prototype.removeController=function(e){this.controllerStack.remove(e)},e.prototype.setBounds=function(e){e?(this.bounds=e,this.setPosition(this.rect.left,this.rect.top)):this.bounds=null},e.prototype.setPosition=function(e,t){this.bounds&&(this.bounds.width<this.rect.width?e=0:e<this.bounds.left?e=this.bounds.left:e>this.bounds.right-this.rect.width&&(e=this.bounds.right-this.rect.width),this.bounds.height<this.rect.height?t=0:t<this.bounds.top?t=this.bounds.top:t>this.bounds.bottom-this.rect.height&&(t=this.bounds.bottom-this.rect.height)),this.rect.setPosition(Math.floor(e),Math.floor(t))},e.prototype.setScale=function(e){this.scale=Utility.clamp(e,this.minScale,this.maxScale),this.onResize()},e.prototype.toScreen=function(e,t){return new Vector2((e-this.rect.left)*this.scale,(t-this.rect.top)*this.scale)},e.prototype.update=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.updateController()},e.prototype.updateController=function(){var e=this.controllerStack.first;if(e&&e.target){var t=e.border,i=e.border;e.isPercentageBased&&(t*=this.rect.width,i*=this.rect.height);var n=e.target.rect.center.x,r=e.target.rect.center.y;e.leadTarget&&(n+=e.target.velocity.x*e.leadScale,r+=e.target.velocity.y*e.leadScale);var s,a;e.centerTarget?(s=n-this.rect.width/2,a=r-this.rect.height/2):(s=this.rect.left,a=this.rect.top);var o=s+this.rect.width-t,l=a+this.rect.height-i;e.target.rect.left<s+t?s=e.target.rect.left-t:e.target.rect.right>o&&(s=s+e.target.rect.right-o),e.target.rect.top<a+i?a=e.target.rect.top-i:e.target.rect.bottom>l&&(a=a+e.target.rect.bottom-l),(s!==this.rect.x||a!==this.rect.y)&&this.setPosition(s,a)}},new e}),define("engine/core/scheduler",[],function(){"use strict";function e(){}function t(a){if(e.isRunning){var o=.001*(a-s);s=a,o>.05&&(o=.05);for(var l=n.first;l;)l.timeRemaining-=o,l.timeRemaining<0&&(l.method.call(l.context,l,o),l.timeRemaining+=l.interval,l.timeRemaining<0&&(l.timeRemaining=0)),l=l.next;for(l=r.first;l;)l.timeRemaining-=o,l.timeRemaining<0&&r.remove(l),l=l.next;i=window.requestAnimationFrame(t)}}var i,n,r,s=0;return e.isRunning=!1,e.priority={update:1e3,animation:500,render:100},e.limitExecution=function(e,t,i){for(var n=r.first;n;){if(n.method===e&&n.context===t)return;n=n.next}r.addLast({method:e,context:t,timeRemaining:i}),e.apply(t)},e.start=function(){n||(n=new LinkedList),r||(r=new LinkedList),e.isRunning=!0,i=window.requestAnimationFrame(t)},e.stop=function(){e.isRunning=!1,window.cancelAnimationFrame(i)},e.schedule=function(t){null==t.interval&&(t.interval=0),null==t.priority&&(t.priority=e.priority.update),t.timeRemaining=t.interval,n.insertSorted(t,"priority")},e.unschedule=function(e){n.remove(e)},e.unscheduleById=function(e){n.removeBy("id",e)},e}),define("engine/core/linkedList",[],function(){"use strict";function e(){this.first=null}return e.prototype.addFirst=function(e){e.next=this.first,this.first=e},e.prototype.addLast=function(e){if(e.next=null,this.first){for(var t=this.first;t.next;)t=t.next;t.next=e}else this.first=e},e.prototype.insertSorted=function(e,t){if(this.first)if(this.first[t]<e[t])e.next=this.first,this.first=e;else{for(var i=this.first;i.next&&i.next[t]>e[t];)i=i.next;e.next=i.next,i.next=e}else this.first=e},e.prototype.remove=function(e){if(this.first)if(this.first===e)this.first=this.first.next;else for(var t=this.first;t&&t.next;){if(t.next===e){t.next=t.next.next;break}t=t.next}},e.prototype.removeBy=function(e,t){if(this.first)if(this.first[e]===t)this.first=this.first.next;else for(var i=this.first;i&&i.next;){if(i.next[e]===t){i.next=i.next.next;break}i=i.next}},e.prototype.removeFirst=function(){this.first&&(this.first=this.first.next)},e.prototype.removeLast=function(){if(this.first&&this.first.next){for(var e=this.first;e.next.next;)e=e.next;e.next=null}else this.first=null},e}),define("engine/core/rectangle",[],function(){"use strict";function e(e,t,i,n){this.width=i,this.height=n,this.center=new Vector2,this.setPosition(e,t)}return e.prototype.getPosition=function(){return new Vector2(this.left,this.top)},e.prototype.getSize=function(){return new Vector2(this.width,this.height)},e.prototype.setCenter=function(e,t){this.center.x=e,this.center.y=t;var i=this.width/2,n=this.height/2;this.left=e-i,this.top=t-n,this.right=e-i,this.bottom=t-n},e.prototype.setPosition=function(e,t){this.left=e,this.top=t,this.right=e+this.width,this.bottom=t+this.height,this.center.x=e+this.width/2,this.center.y=t+this.height/2},e.prototype.setSize=function(e,t){this.width=e,this.height=t,this.right=this.left+this.width,this.bottom=this.top+this.height,this.center.x=this.left+this.width/2,this.center.y=this.top+this.height/2},e.prototype.setSizeFromCenter=function(e,t){this.width=e,this.height=t;var i=this.width/2,n=this.height/2;this.left=this.center.x-i,this.top=this.center.y-n,this.right=this.center.x+i,this.bottom=this.center.y+n},e.prototype.translate=function(e,t){this.setPosition(this.left+e,this.top+t)},e.fromPoints=function(t,i,n,r){var s,a,o,l;return n>t?(s=t,o=n-t):(s=n,o=t-n),r>i?(a=i,l=r-i):(a=r,l=i-r),new e(s,a,o,l)},e}),define("engine/core/utility",[],function(){"use strict";function e(){}e.appendElements=function(e,t){if(Array.isArray(t))for(var i=0;i<t.length;i++)e.appendChild(t[i]);else e.appendChild(t)},e.clamp=function(e,t,i){return t>=e?t:e>=i?i:e},e.findByProperty=function(e,t,i){for(var n=0;n<e.length;n++)if(e[n][t]===i)return e[n]},e.findByProperties=function(e,t){for(var i=0;i<e.length;i++){var n=!0;for(var r in t)if(e[i][r]!==t[r]){n=!1;break}if(n)return e[i]}},e.findParent=function(t,i){for(;t&&!e.matches(t,i);)t=t.parentNode;return t},e.getElementFromTemplate=function(e,t){var i=document.createElement("div");i.innerHTML=e;for(var n=[];i.firstChild;)n.push(i.firstChild),t?t.appendChild(i.firstChild):i.removeChild(i.firstChild);return n.length>1?n:n[0]},e.getSign=function(e){return e?0>e?-1:1:0},e.inherit=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.parent=t.prototype},e.matches=function(e,i){return e[t]?e[t](i):void 0},e.merge=function(){for(var e=arguments[0],t=1;t<arguments.length;t++){var i=arguments[t];if(i)for(var n in i)e[n]=i[n]}return e},e.remove=function(e,t){var i=e.indexOf(t);return i>=0?(e.splice(i,1),!0):void 0},e.removeByProperty=function(e,t,i){for(var n=0;n<e.length;n++)if(e[n][t]===i)return e.splice(n,1)[0]},e.removeByProperties=function(e,t){for(var i=0;i<e.length;i++){var n=!0;for(var r in t)if(e[i][r]!==t[r]){n=!1;break}if(n)return e.splice(i,1)[0]}};for(var t,i=["matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","oMatchesSelector"],n=document.createElement("div"),r=0;r<i.length;r++)if(n[i[r]]){t=i[r];break}return e}),define("engine/core/vector2",[],function(){"use strict";function e(e,t){this.x=e||0,this.y=t||0}return e.prototype.angle=function(e){return null==e?Math.atan2(this.y,this.x):(this.x=Math.cos(e),this.y=Math.sin(e),void 0)},e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},e.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y);return this.x/=e,this.y/=e,e},e.prototype.rotate=function(e){var t=Math.sin(e),i=Math.cos(e);this.x=this.x*i-this.y*t,this.y=this.x*t+this.y*i,this.normalize()},e.add=function(t,i){return new e(t.x+i.x,t.y+i.y)},e.distance=function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},e.distanceSquared=function(e,t){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n},e.divide=function(t,i){return new e(t.x/i,t.y/i)},e.dot=function(e,t){return e.x*t.x+e.y*t.y},e.leftPerpendicular=function(t){return new e(t.y,-t.x)},e.multiply=function(t,i){return new e(t.x*i,t.y*i)},e.normalize=function(t){var i=Math.sqrt(t.x*t.x+t.y*t.y);return new e(t.x/i,t.y/i)},e.reverse=function(t){return new e(-t.x,-t.y)},e.rightPerpendicular=function(t){return new e(-t.y,t.x)},e.subtract=function(t,i){return new e(t.x-i.x,t.y-i.y)},e}),define("engine/game/game",["./viewport","../core/scheduler","../core/linkedList","../core/rectangle","../core/utility","../core/vector2"],function(e,t,i,n,r,s){"use strict";function a(){}return window.LinkedList=i,window.Rectangle=n,window.Utility=r,window.Vector2=s,a.prototype.onReady=function(i){var n=setInterval(function(){"complete"===document.readyState&&(clearInterval(n),t.start(),e.initialize(),i())},20)},a.prototype.setScene=function(t){this.scene&&this.scene.close(),this.scene=t,e.setBounds(t.rect)},new a}),define("engine/data/fileHandler",[],function(){"use strict";var e=window.URL||window.webkitURL;return{loadImage:function(e,t){if(e&&e.type.match("image.*")){var i=new FileReader;return i.onload=function(i){t(e.name,i.target.result)},i.readAsDataURL(e),!0}},loadJSON:function(e,t){if(e){var i=e.name.lastIndexOf("."),n=e.name.substr(i+1);if("json"!==n.toLowerCase())return;var r=new FileReader;return r.onload=function(i){t(e.name,JSON.parse(i.target.result))},r.readAsText(e),!0}},requestJSON:function(e,t){var i=new XMLHttpRequest;i.overrideMimeType("application/json"),i.open("GET",e+".json"),i.onreadystatechange=function(){4===i.readyState&&200===i.status&&t(JSON.parse(i.responseText))},i.send()},saveJSON:function(t,i){Array.isArray(i)||(i=[i]);var n;try{n=e.createObjectURL(new Blob(i,{type:"application/json"}));var r=document.createElement("a");r.href=n,r.target="_target",r.download=t,r.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}))}catch(s){console.log(s)}finally{n&&e.revokeObjectURL(n)}}}}),define("engine/media/imageCache",[],function(){"use strict";function e(e,i){var n={isLoaded:!1,data:new Image,callback:i};return n.data.onload=t.bind(n),n.data.src=e,n}function t(){this.width=this.data.width,this.height=this.data.height,this.isLoaded=!0,this.callback&&(this.callback(this),this.callback=void 0),this.data.onload=void 0}function i(){}var n={};return i.clear=function(){n={}},i.createImage=function(t,i){return e(t,i)},i.getAll=function(){var e=[];for(var t in n)e.push(n[t]);return e},i.getImage=function(e){return n[e]},i.isLoading=function(){for(var e in n)if(n.hasOwnProperty(e)&&!n[e].isLoaded)return!0;return!1},i.loadImage=function(t,i,r){var s=n[t];return s||(s=e(i,r),s.id=t,n[t]=s),s},i.unloadImage=function(e){delete n[e]},i}),define("engine/core/events",[],function(){"use strict";function e(){var e=arguments[0];this.events||(this.events={}),this.events[e]||(this.events[e]=[]);var t,i;arguments.length>2?(t=arguments[1],i=arguments[2]):i=arguments[1],this.events[e].push({context:t,method:i})}function t(){if(this.events){var e=arguments[0];arguments.length>=3?Utility.removeByProperties(this.events[e],{context:arguments[1],method:arguments[2]}):2===arguments.length?Utility.removeByProperty(this.events[e],"method",arguments[1]):this.events[e]=void 0}}function i(){if(this.events){var e=this.events[arguments[0]];if(e&&e.length){Array.prototype.shift.call(arguments);for(var t=0;t<e.length;t++){var i=e[t];i.method.apply(i.context,arguments)}}}}return{register:function(n){n.on=e,n.off=t,n.trigger=i}}}),define("engine/core/inputHandler",["./events"],function(e){"use strict";function t(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)>10}function i(e){var i=null!=e.identifier?e.identifier:"mouse",n=N[i];if(n){var r=n.events[0],s=n.events[n.events.length-1];if(r.targetId===s.targetId){if(n.isDragging){var a=n.events[n.events.length-2],o=a.x-s.x,l=a.y-s.y;M.trigger("drag",e,o,l)}else t(r,s)&&(n.isDragging=!0,M.trigger("dragBegin",s));return!0}}}function n(e){var t=null!=e.identifier?e.identifier:"mouse",i=N[t];if(i){var n=i.events;if(!(n.length>1&&n[0].targetId!==n[n.length-1].targetId)){if(i.isDragging){var r=n.pop(),s=n.pop(),a=r.x-s.x,o=r.y-s.y;M.trigger("dragEnd",e,a,o)}else M.trigger("click",e);delete N[i.id]}}}function r(e,t,i){var n=N[t.identifier],r=N[i.identifier],s=n.events[0],a=r.events[0];if(!(Math.abs(s.timestamp-a.timestamp)>250)){var o=n.events[n.events.length-1],l=r.events[r.events.length-1],h=n.events[n.events.length-2],c=r.events[r.events.length-2],d=Math.abs(h.x-c.x)+Math.abs(h.y-c.y),u=Math.abs(o.x-l.x)+Math.abs(o.y-l.y),p=(o.x+l.x)/2,f=(o.y+l.y)/2,y=document.body.offsetWidth+document.body.offsetHeight,m=5*(u-d)/y;return M.trigger("pinch",e,p,f,m),!0}}function s(e){var t=null!=e.identifier?e.identifier:"mouse",i=N[t];return i||(i={id:t,events:[]},N[t]=i),i.events.push({targetId:e.target.id,timestamp:e.timeStamp,x:e.pageX,y:e.pageY}),i}function a(e){if(P){var t=I[e.keyCode]?M.Keys.Control:e.keyCode;T[t]=!0,g(z,t)||M.trigger("keydown",e)}}function o(e){if(P){var t=I[e.keyCode]?M.Keys.Control:e.keyCode;T[t]=!1,w(z,t)||M.trigger("keyup",e)}}function l(e){P&&m(e.target.id,e.button)&&(s(e),M.trigger("mousedown",e))}function h(e){P&&(N.mouse&&(s(e),i(e)),M.trigger("mousemove",e))}function c(e){P&&(n(e),b(e.target.id,e.button),M.trigger("mouseup",e))}function d(e){if(P){var t=Utility.clamp(e.wheelDelta||-e.detail,-1,1);M.trigger("mousewheel",e,.15*t)}}function u(e){if(P&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];s(i),m(i.target.id,M.Keys.MouseLeft)}e.preventDefault()}function p(e){if(P&&e.touches){for(var t=0;t<e.touches.length;t++)s(e.touches[t]);var n;if(1===e.touches.length?n=i(e.touches[0]):2===e.touches.length&&(n=r(e,e.touches[0],e.touches[1])),!n)for(t=0;t<e.touches.length;t++){var a=e.touches[t],o=N[a.identifier].events[0];b(o.targetId,M.Keys.MouseLeft),m(a.target.id,M.Keys.MouseLeft)}}e.preventDefault()}function f(e){if(P&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];n(i),b(i.target.id,M.Keys.MouseLeft)}e.preventDefault()}function y(e){if(P&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];delete N[i.identifier],b(i.target.id,M.Keys.MouseLeft)}}function m(e,t){return g(q,e)?void 0:(T[t]=!0,g(z,t),!0)}function g(e,t){var i=e[t];if(i){for(var n=0;n<i.length;n++)v(i[n]);return!0}return!1}function v(e){var t=C[e];t&&(E[t.name]=!0,k[t.name]||(k[t.name]=!0,M.trigger(t.name)))}function b(e,t){return w(q,e)?void 0:(T[t]=!1,w(z,t),!0)}function w(e,t){var i=e[t];if(i){for(var n=0;n<i.length;n++)S(i[n]);return!0}return!1}function S(e){var t=C[e];t&&(E[t.name]=!1,k[t.name]=!1)}function x(e,t,i,n){i&&(e[t]?e[t].push(i):e[t]=[i],n&&(n[i]?n[i].push(e.name):n[i]=[e.name]))}function L(e,t,i,n){if(null!=i){e[t]&&Utility.remove(e[t],i);var r=n[i];r&&(Utility.remove(r,e.name),r.length||(n[i]=void 0))}}function M(){}var P=!0,I={17:!0,91:!0,93:!0,224:!0},C={},E={},k={},T={},N={},z={},q={};M.isTouchEnabled="ontouchstart"in window||"onmsgesturechange"in window,M.Keys={MouseLeft:0,MouseMiddle:1,MouseRight:2,Backspace:8,Enter:13,Shift:16,Control:17,Alt:18,Escape:27,Spacebar:32,Left:37,Up:38,Right:39,Down:40,Delete:46,Number0:48,Number1:49,Number2:50,Number3:51,Number4:52,Number5:53,Number6:54,Number7:55,Number8:56,Number9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Tilde:192},M.clearInput=function(){T={},E={},N={},k={}},M.disableInput=function(){P=!1},M.enableInput=function(){P=!0},M.isActive=function(e){return E[e]},M.isKeyDown=function(e){return T[e]},M.registerAction=function(e,t,i){var n=e.name,r=C[n];r||(r={name:n},C[n]=r),x(r,"inputKeys",e.key,z),x(r,"elementIds",e.elementId,q),i&&M.on(n,t,i)},M.unregisterAction=function(e){var t=C[e.name];t&&(L(t,"inputKeys",e.key,z),L(t,"elementIds",e.elementId,q),t.inputKeys&&t.inputKeys.length||t.elementIds&&t.elementIds.length||(C[e.name]=void 0))};var R=function(e){e.preventDefault()},H=function(e){var t=e.target.tagName;t&&"canvas"===t.toLowerCase()&&e.preventDefault()};return window.addEventListener("contextmenu",R,!1),window.addEventListener("MSHoldVisual",R,!1),window.addEventListener("ondragstart",R,!1),window.addEventListener("ondrop",R,!1),window.addEventListener("selectstart",H,!1),window.addEventListener("keydown",a,!1),window.addEventListener("keyup",o,!1),window.addEventListener("mousedown",l,!1),window.addEventListener("mousemove",h,!1),window.addEventListener("mouseup",c,!1),window.addEventListener("mousewheel",d,!1),window.addEventListener("DOMMouseScroll",d,!1),window.addEventListener("blur",M.clearInput),M.isTouchEnabled&&(window.addEventListener("touchstart",u,!1),window.addEventListener("touchmove",p,!1),window.addEventListener("touchend",f,!1),window.addEventListener("touchcancel",y,!1),document.body.msTouchAction="none",document.body.className+=" touch"),e.register(M),M}),define("editor/core/popup",["engine/core/events"],function(e){"use strict";function t(e){this.items=e}var i;return t.prototype.close=function(){document.body.removeChild(this.element),i=null,this.trigger("close")},t.prototype.onClick=function(e){for(var t=Utility.findParent(e.target,".popup-item"),i=0;i<this.itemMap.length;i++){var n=this.itemMap[i];if(n.element===t){this.trigger("itemClick",n.itemObject),this.close();break}}},t.prototype.show=function(e,t){i&&i.close(),this.element=document.createElement("div"),this.element.className="popup popup-menu",this.itemMap=[];for(var n in this.items)if(this.items.hasOwnProperty(n)){var r=document.createElement("div");r.className="popup-item";var s=document.createElement("span");s.appendChild(document.createTextNode(n)),r.appendChild(s),this.element.appendChild(r),this.itemMap.push({itemObject:this.items[n],element:r})}document.body.appendChild(this.element);var a=this.element.offsetWidth,o=this.element.offsetHeight,l=document.body.clientWidth,h=document.body.clientHeight;return this.left=e-a/2,this.top=t+16,this.element.style.top=Utility.clamp(this.top,8,h-o-8)+"px",this.element.style.left=Utility.clamp(this.left,8,l-a-8)+"px",this.element.style.maxWidth=l+"px",this.element.style.maxHeight=h+"px",this.element.addEventListener("click",this.onClick.bind(this),!1),i=this,this},window.addEventListener("mousedown",function(e){i&&!Utility.findParent(e.target,".popup")&&i.close()},!1),e.register(t.prototype),t}),define("engine/spatial/tileMap",[],function(){"use strict";function e(e,t,i,n){this.width=e,this.height=t,this.tileSize=i,this.tiles=n===!1?[]:new Uint8Array(new ArrayBuffer(e*t))}return e.prototype.getTile=function(e,t){return this.tiles[e+t*this.width]},e.prototype.getTileAtIndex=function(e){return this.tiles[e]},e.prototype.getTileAtPosition=function(e,t){return e=Math.floor(e/this.tileSize),t=Math.floor(t/this.tileSize),this.tiles[e+t*this.width]},e.prototype.isInBounds=function(e,t){return e>=0&&t>=0&&e<this.width&&t<this.height},e.prototype.setTile=function(e,t,i){this.tiles[e+t*this.width]=i},e.prototype.setTileAtIndex=function(e,t){this.tiles[e]=t},e.prototype.setTileAtPosition=function(e,t,i){e=Math.floor(e/this.tileSize),t=Math.floor(t/this.tileSize),this.tiles[e+t*this.width]=i},e}),define("engine/data/webStorage",["../core/events"],function(e){"use strict";function t(){}var i;return t.setSaveInterval=function(e){i&&clearInterval(i),i=setInterval(function(){t.trigger("save")},1e3*e)},t.getData=function(e){if(window.localStorage){var t=window.localStorage.getItem(e);if(t)return JSON.parse(t)}},t.deleteData=function(){if(window.localStorage)for(var e=0;e<arguments.length;e++)window.localStorage.removeItem(arguments[e])},t.hasData=function(){if(!window.localStorage)return!1;for(var e=0;e<arguments.length;e++)if(!window.localStorage.getItem(arguments[e]))return!1;return!0},t.setData=function(e,t){if(window.localStorage)try{window.localStorage.setItem(e,JSON.stringify(t))}catch(i){}},window.localStorage&&window.addEventListener("beforeunload",function(){t.trigger("save")},!1),e.register(t),t}),define("text",["module"],function(e){"use strict";var t,i,n,r,s,a=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],o=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,l=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,h="undefined"!=typeof location&&location.href,c=h&&location.protocol&&location.protocol.replace(/\:/,""),d=h&&location.hostname,u=h&&(location.port||void 0),p={},f=e.config&&e.config()||{};return t={version:"2.0.9",strip:function(e){if(e){e=e.replace(o,"");var t=e.match(l);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:f.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){i=a[t];try{e=new ActiveXObject(i)}catch(n){}if(e){a=[i];break}}return e},parseName:function(e){var t,i,n,r=!1,s=e.indexOf("."),a=0===e.indexOf("./")||0===e.indexOf("../");return-1!==s&&(!a||s>1)?(t=e.substring(0,s),i=e.substring(s+1,e.length)):t=e,n=i||t,s=n.indexOf("!"),-1!==s&&(r="strip"===n.substring(s+1),n=n.substring(0,s),i?i=n:t=n),{moduleName:t,ext:i,strip:r}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,i,n,r){var s,a,o,l=t.xdRegExp.exec(e);return l?(s=l[2],a=l[3],a=a.split(":"),o=a[1],a=a[0],!(s&&s!==i||a&&a.toLowerCase()!==n.toLowerCase()||(o||a)&&o!==r)):!0},finishLoad:function(e,i,n,r){n=i?t.strip(n):n,f.isBuild&&(p[e]=n),r(n)},load:function(e,i,n,r){if(r.isBuild&&!r.inlineText)return n(),void 0;f.isBuild=r.isBuild;var s=t.parseName(e),a=s.moduleName+(s.ext?"."+s.ext:""),o=i.toUrl(a),l=f.useXhr||t.useXhr;!h||l(o,c,d,u)?t.get(o,function(i){t.finishLoad(e,s.strip,i,n)},function(e){n.error&&n.error(e)}):i([a],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,n)})},write:function(e,i,n){if(p.hasOwnProperty(i)){var r=t.jsEscape(p[i]);n.asModule(e+"!"+i,"define(function () { return '"+r+"';});\n")}},writeFile:function(e,i,n,r,s){var a=t.parseName(i),o=a.ext?"."+a.ext:"",l=a.moduleName+o,h=n.toUrl(a.moduleName+o)+".js";t.load(l,n,function(){var i=function(e){return r(h,e)};i.asModule=function(e,t){return r.asModule(e,h,t)},t.write(e,l,i,s)},s)}},"node"===f.env||!f.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]?(i=require.nodeRequire("fs"),t.get=function(e,t,n){try{var r=i.readFileSync(e,"utf8");0===r.indexOf("﻿")&&(r=r.substring(1)),t(r)}catch(s){n(s)}}):"xhr"===f.env||!f.env&&t.createXhr()?t.get=function(e,i,n,r){var s,a=t.createXhr();if(a.open("GET",e,!0),r)for(s in r)r.hasOwnProperty(s)&&a.setRequestHeader(s.toLowerCase(),r[s]);f.onXhr&&f.onXhr(a,e),a.onreadystatechange=function(){var t,r;4===a.readyState&&(t=a.status,t>399&&600>t?(r=new Error(e+" HTTP status: "+t),r.xhr=a,n(r)):i(a.responseText),f.onXhrComplete&&f.onXhrComplete(a,e))},a.send(null)}:"rhino"===f.env||!f.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?t.get=function(e,t){var i,n,r="utf-8",s=new java.io.File(e),a=java.lang.System.getProperty("line.separator"),o=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),r)),l="";try{for(i=new java.lang.StringBuffer,n=o.readLine(),n&&n.length()&&65279===n.charAt(0)&&(n=n.substring(1)),null!==n&&i.append(n);null!==(n=o.readLine());)i.append(a),i.append(n);l=String(i.toString())}finally{o.close()}t(l)}:("xpconnect"===f.env||!f.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(n=Components.classes,r=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in n,t.get=function(e,t){var i,a,o,l={};s&&(e=e.replace(/\//g,"\\")),o=new FileUtils.File(e);try{i=n["@mozilla.org/network/file-input-stream;1"].createInstance(r.nsIFileInputStream),i.init(o,1,0,!1),a=n["@mozilla.org/intl/converter-input-stream;1"].createInstance(r.nsIConverterInputStream),a.init(i,"utf-8",i.available(),r.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),a.readString(i.available(),l),a.close(),i.close(),t(l.value)}catch(h){throw new Error((o&&o.path||"")+": "+h)}}),t}),define("text!editor/templates/mainPanel.html",[],function(){return'<div class="panel main-panel">\r\n    <div data-name="level-panel">\r\n        <div class="header">\r\n            <label>Level</label>\r\n        </div>\r\n        <div class="contents">\r\n            <input data-name="saveFileName" type="text" placeholder="File name"/>\r\n            <button data-name="new">New</button>\r\n            <button data-name="save">Save</button>\r\n            <div>\r\n                <input type="file" data-name="load"/>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div data-name="grid-panel">\r\n        <div class="header">\r\n            <label>Grid</label>\r\n            <div class="header-button-panel">\r\n                <div class="icon visibility-icon" title="Toggle grid visibility"></div>\r\n            </div>\r\n        </div>\r\n        <div class="contents">\r\n            <div>\r\n                <span>Width:</span>\r\n                <input class="numeric-input" type="number" data-name="width" min="1"/>\r\n                <span>Height:</span>\r\n                <input class="numeric-input" type="number" data-name="height" min="1"/>\r\n            </div>\r\n            <div>\r\n                <span>Tile Size:</span>\r\n                <input class="numeric-input" type="number" data-name="tileSize" min="1"/>\r\n                <button data-name="apply">Apply</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div data-name="layer-panel">\r\n        <div class="header">\r\n            <label>Layers</label>\r\n            <div class="header-button-panel">\r\n                <div class="icon up-icon" title="Move layer up"></div>\r\n                <div class="icon down-icon" title="Move layer down"></div>\r\n                <div class="icon add-icon" title="Add layer"></div>\r\n            </div>\r\n        </div>\r\n        <div class="layer-item-panel"></div>\r\n    </div>\r\n    <div class="active-layer-panel">\r\n        <div class="header">\r\n            <label>Layer Properties</label>\r\n        </div>\r\n    </div>\r\n</div>'}),define("text!editor/templates/layer.html",[],function(){return'<div class="layer">\r\n    <div class="icon visibility-icon visible" title="Toggle layer visibility"></div>\r\n    <div class="layer-title-container">\r\n        <input type="text"/>\r\n    </div>\r\n    <div class="icon remove-icon" title="Remove layer"></div>\r\n</div>'}),define("editor/core/mainPanel",["Editor","engine/core/events","engine/data/fileHandler","../core/popup","text!../templates/mainPanel.html","text!../templates/layer.html"],function(e,t,i,n,r,s){"use strict";function a(t){this.layers=[],this.layerTypes={};var i={isVisible:!1,tileSize:64,rect:new Rectangle(0,0,64,64)};e.getGridSettings=function(){return i},this.grid=i;for(var n=0;n<t.length;n++){var s=t[n];this.layerTypes[s.type]=s}document.body.insertAdjacentHTML("beforeend",r),this.element=document.body.querySelector(".main-panel"),this.levelPanel=this.element.querySelector('[data-name="level-panel"'),this.gridPanel=this.element.querySelector('[data-name="grid-panel"'),this.layerPanel=this.element.querySelector('[data-name="layer-panel"'),this.layerItemPanel=this.layerPanel.querySelector(".layer-item-panel"),this.activeLayerPanel=this.element.querySelector(".active-layer-panel"),this.activeLayerPanel.style.display="none",this.initialize()}function o(e,t){e.isVisible=!e.isVisible,e.isVisible?t.classList.add("visible"):t.classList.remove("visible")}return a.prototype.initialize=function(){this.gridPanel.querySelector('[data-name="tileSize"]').value=this.grid.tileSize,this.gridPanel.querySelector('[data-name="width"]').value=this.grid.rect.width,this.gridPanel.querySelector('[data-name="height"]').value=this.grid.rect.height,this.element.addEventListener("click",this.onClick.bind(this)),this.levelPanel.querySelector('[data-name="new"]').addEventListener("click",this.onNew.bind(this),!1),this.levelPanel.querySelector('[data-name="load"]').addEventListener("change",this.onLoad.bind(this),!1),this.levelPanel.querySelector('[data-name="save"]').addEventListener("click",this.onSave.bind(this),!1),this.gridPanel.querySelector('[data-name="apply"]').addEventListener("click",this.onApplyGridChanges.bind(this),!1),this.gridPanel.querySelector(".visibility-icon").addEventListener("click",this.onToggleGridVisibility.bind(this),!1),this.layerPanel.querySelector(".add-icon").addEventListener("click",this.onAddLayer.bind(this),!1),this.layerPanel.querySelector(".up-icon").addEventListener("click",this.onMoveLayerUp.bind(this),!1),this.layerPanel.querySelector(".down-icon").addEventListener("click",this.onMoveLayerDown.bind(this),!1)},a.prototype.onAddLayer=function(e){this.popup=new n(this.layerTypes).show(e.pageX,e.pageY),this.popup.on("close",this,function(){this.popup=null}.bind(this)),this.popup.on("itemClick",this,function(e){this.createLayerFromType(e)}.bind(this))},a.prototype.onMoveLayerUp=function(){if(this.layers.length>1){var e=this.layers.indexOf(this.selectedLayer);e>0&&(this.layers.splice(e-1,0,this.layers.splice(e,1)[0]),this.layerItemPanel.insertBefore(this.selectedLayer.element,this.selectedLayer.element.previousSibling))}},a.prototype.onMoveLayerDown=function(){if(this.layers.length>1){var e=this.layers.indexOf(this.selectedLayer);e<this.layers.length-1&&(this.layers.splice(e+1,0,this.layers.splice(e,1)[0]),this.layerItemPanel.insertBefore(this.selectedLayer.element.nextSibling,this.selectedLayer.element))}},a.prototype.createLayer=function(e){var t={object:e,element:Utility.getElementFromTemplate(s,this.layerItemPanel),isVisible:null!=e.isVisible?e.isVisible:!0};t.title=t.element.querySelector("input"),t.title.value=e.name,this.layers.push(t),this.selectedLayer||this.selectLayer(t)},a.prototype.createLayerFromType=function(e){var t=new e;t.type=e.type,this.createLayer(t)},a.prototype.removeLayer=function(e){this.layerItemPanel.removeChild(e.element),Utility.remove(this.layers,e),this.selectedLayer===e&&this.selectLayer(this.layers[0])},a.prototype.selectLayer=function(e){if(this.selectedLayer!==e){this.selectedLayer&&(this.selectedLayer.object.isSelected=!1,this.selectedLayer.element.classList.remove("selected"),this.selectedLayer.object.onDeselected&&this.selectedLayer.object.onDeselected()),this.selectedLayer=e;for(var t=this.activeLayerPanel.querySelector(".header");this.activeLayerPanel.lastChild!==t;)this.activeLayerPanel.removeChild(this.activeLayerPanel.lastChild);var i;this.selectedLayer&&(this.selectedLayer.object.isSelected=!0,this.selectedLayer.element.classList.add("selected"),this.selectedLayer.object.getPanel&&(i=this.selectedLayer.object.getPanel()),this.selectedLayer.object.onSelected&&this.selectedLayer.object.onSelected()),i?(Utility.appendElements(this.activeLayerPanel,i),this.activeLayerPanel.style.display=""):this.activeLayerPanel.style.display="none"
}},a.prototype.updateLayerNames=function(){for(var e=0;e<this.layers.length;e++){var t=this.layers[e];t.object.name=t.title.value}},a.prototype.onApplyGridChanges=function(){var e=this.gridPanel.querySelector('[data-name="tileSize"]'),t=this.gridPanel.querySelector('[data-name="width"]'),i=this.gridPanel.querySelector('[data-name="height"]'),n=parseInt(e.value,10),r=parseInt(t.value,10),s=parseInt(i.value,10);this.grid.tileSize=n||this.grid.tileSize,this.grid.rect.setSize(r||this.grid.rect.width,s||this.grid.rect.height),e.value=this.grid.tileSize,t.value=this.grid.rect.width,i.value=this.grid.rect.height},a.prototype.onToggleGridVisibility=function(e){o(this.grid,e.target)},a.prototype.clear=function(){for(this.layers.length=0,this.selectLayer(null);this.layerItemPanel.firstChild;)this.layerItemPanel.removeChild(this.layerItemPanel.firstChild)},a.prototype.loadLayers=function(e,t){var i=this.element.querySelector('[data-name="saveFileName"]');if(i.value=e.substr(0,e.lastIndexOf(".")),t&&t.length)for(var n=0;n<t.length;n++){var r=t[n];if(this.layerTypes[r.type]){var s=new this.layerTypes[r.type];s.name=r.name,s.type=r.type,s.deserialize(r.data),this.createLayer(s)}}},a.prototype.onClick=function(e){var t=Utility.findParent(e.target,".layer");if(t){var i=Utility.findByProperty(this.layers,"element",t);Utility.matches(e.target,".remove-icon")?this.removeLayer(i):(this.selectLayer(i),Utility.matches(e.target,".visibility-icon")&&o(i,e.target))}e.stopPropagation()},a.prototype.onNew=function(){this.clear()},a.prototype.onLoad=function(e){i.loadJSON(e.target.files[0],function(e,t){this.trigger("load",e,t)}.bind(this))},a.prototype.onSave=function(e){this.updateLayerNames();var t=this.element.querySelector('[data-name="saveFileName"]').value;this.trigger("save",t),e.stopPropagation()},t.register(a.prototype),a}),define("editor/core/editorInterface",["Editor","engine/game/viewport","./mainPanel"],function(e,t,i){"use strict";function n(t){e.Scheduler.schedule({context:this,method:this.draw,priority:e.Scheduler.priority.render}),e.Scheduler.schedule({context:this,method:this.update}),e.InputHandler.on("mousedown",this,this.forwardEvent.bind(this,"onMouseDown")),e.InputHandler.on("mousemove",this,this.forwardEvent.bind(this,"onMouseMove")),e.InputHandler.on("mouseup",this,this.forwardEvent.bind(this,"onMouseUp")),e.InputHandler.on("click",this,this.forwardEvent.bind(this,"onClick")),e.InputHandler.on("keydown",this,this.forwardEvent.bind(this,"onKeyDown")),e.InputHandler.on("keyup",this,this.forwardEvent.bind(this,"onKeyUp")),e.InputHandler.on("drag",this.onDrag.bind(this)),e.InputHandler.on("pinch",this.onPinch.bind(this)),e.InputHandler.on("mousewheel",this.onMouseWheel.bind(this)),this.plugins=t,this.mainPanel=new i(this.plugins.layers),this.mainPanel.on("load",this.onLoad.bind(this)),this.mainPanel.on("save",this.onSave.bind(this)),this.loadResources()}function r(e){return e.target.tagName&&"canvas"===e.target.tagName.toLowerCase()}return n.prototype.update=function(e,i){var n=this.plugins.plugins;if(n)for(var r=0;r<n.length;r++){var s=n[r];s.update&&s.update(i)}t.update(i)},n.prototype.draw=function(e,i){for(var n=this.mainPanel.layers.length-1;n>=0;n--){var r=this.mainPanel.layers[n];r.isVisible&&r.object.draw&&r.object.draw(t,i)}var s=this.mainPanel.grid;if(s.isVisible){var a=this.mainPanel.grid.tileSize,o=Math.max(0,Math.floor(t.rect.left/a)),l=Math.max(0,Math.floor(t.rect.top/a)),h=Math.min(s.rect.width,Math.ceil(t.rect.right/a)),c=Math.min(s.rect.height,Math.ceil(t.rect.bottom/a));t.context.strokeStyle="blue",t.context.lineWidth=.5;for(var d=Math.floor((l*a-t.rect.top)*t.scale),u=Math.floor((c*a-t.rect.top)*t.scale),p=o;h>=p;p++){var f=Math.floor((p*a-t.rect.left)*t.scale);t.context.beginPath(),t.context.moveTo(f,d),t.context.lineTo(f,u),t.context.stroke()}for(var y=Math.floor((o*a-t.rect.left)*t.scale),m=Math.floor((h*a-t.rect.left)*t.scale),g=l;c>=g;g++){var v=Math.floor((g*a-t.rect.top)*t.scale);t.context.beginPath(),t.context.moveTo(y,v),t.context.lineTo(m,v),t.context.stroke()}}},n.prototype.forwardEvent=function(e,i){if(this.mainPanel.selectedLayer&&this.mainPanel.selectedLayer.isVisible&&r(i)){var n=this.mainPanel.selectedLayer.object;n[e]&&n[e](i,t)}},n.prototype.onDrag=function(e,i,n){2===e.which&&r(e)&&t.move(i/t.scale,n/t.scale)},n.prototype.onPinch=function(e,i,n,s){r(e)&&t.setScale(t.scale+s)},n.prototype.onMouseWheel=function(e,i){e.target.tagName&&"canvas"===e.target.tagName.toLowerCase()&&t.setScale(t.scale+i)},n.prototype.loadResources=function(){if(this.plugins.resources)for(var t=0;t<this.plugins.resources.length;t++){var i=this.plugins.resources[t],n=i.substr(0,i.lastIndexOf("."));e.ImageCache.loadImage(n,"resources/"+i)}},n.prototype.onLoad=function(e,t){t&&(this.mainPanel.clear(),this.mainPanel.loadLayers(e,t.layers))},n.prototype.onSave=function(t){for(var i={layers:[]},n=this.mainPanel.layers,r=0;r<n.length;r++){var s=n[r].object;i.layers.push({name:s.name,type:s.type,data:s.serialize()})}e.FileHandler.saveJSON((t||"level")+".json",JSON.stringify(i))},n}),define("Editor",["engine/data/fileHandler","engine/media/imageCache","engine/core/inputHandler","editor/core/popup","engine/core/scheduler","engine/spatial/tileMap","engine/data/webStorage"],function(e,t,i,n,r,s,a){"use strict";return{FileHandler:e,InputHandler:i,ImageCache:t,Popup:n,Scheduler:r,TileMap:s,WebStorage:a}}),require(["engine/game/game","editor/core/editorInterface"],function(e,t){"use strict";e.onReady(function(){require(["Plugins"],function(i){e.setScene(new t(i))})})}),define("editor/main",function(){});