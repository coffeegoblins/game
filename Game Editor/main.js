/**
 * @license RequireJS text 2.0.9 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

define("engine/game/viewport",[],function(){"use strict";function e(){}var t={border:0,centerTarget:!1,leadTarget:!1,isPercentageBased:!1,leadScale:1};return e.prototype.initialize=function(){this.scale=1,this.minScale=.25,this.maxScale=4,this.rect=new Rectangle(0,0,0,0),this.controllerStack=new LinkedList,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.tabIndex=0,document.body.firstChild?document.body.insertBefore(this.canvas,document.body.firstChild):document.body.appendChild(this.canvas),this.onResize(),window.addEventListener("resize",this.onResize.bind(this))},e.prototype.addController=function(e){var i=Utility.merge({},t,e);return this.controllerStack.addFirst(i),i},e.prototype.fromScreen=function(e,t){return new Vector2(this.rect.left+e/this.scale,this.rect.top+t/this.scale)},e.prototype.move=function(e,t){this.setPosition(this.rect.left+e,this.rect.top+t)},e.prototype.onResize=function(){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight;var e=Math.floor(this.canvas.width/this.scale),t=Math.floor(this.canvas.height/this.scale);this.rect.setSizeFromCenter(e,t)},e.prototype.removeController=function(e){this.controllerStack.remove(e)},e.prototype.setBounds=function(e){e?(this.bounds=e,this.setPosition(this.rect.left,this.rect.top)):this.bounds=null},e.prototype.setPosition=function(e,t){this.bounds&&(this.bounds.width<this.rect.width?e=0:e<this.bounds.left?e=this.bounds.left:e>this.bounds.right-this.rect.width&&(e=this.bounds.right-this.rect.width),this.bounds.height<this.rect.height?t=0:t<this.bounds.top?t=this.bounds.top:t>this.bounds.bottom-this.rect.height&&(t=this.bounds.bottom-this.rect.height)),this.rect.setPosition(Math.floor(e),Math.floor(t))},e.prototype.setScale=function(e){this.scale=Utility.clamp(e,this.minScale,this.maxScale),this.onResize()},e.prototype.toScreen=function(e,t){return new Vector2((e-this.rect.left)*this.scale,(t-this.rect.top)*this.scale)},e.prototype.update=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.updateController()},e.prototype.updateController=function(){var e=this.controllerStack.first;if(e&&e.target){var t=e.border,i=e.border;e.isPercentageBased&&(t*=this.rect.width,i*=this.rect.height);var n=e.target.rect.center.x,r=e.target.rect.center.y;e.leadTarget&&(n+=e.target.velocity.x*e.leadScale,r+=e.target.velocity.y*e.leadScale);var s,o;e.centerTarget?(s=n-this.rect.width/2,o=r-this.rect.height/2):(s=this.rect.left,o=this.rect.top);var a=s+this.rect.width-t,l=o+this.rect.height-i;e.target.rect.left<s+t?s=e.target.rect.left-t:e.target.rect.right>a&&(s=s+e.target.rect.right-a),e.target.rect.top<o+i?o=e.target.rect.top-i:e.target.rect.bottom>l&&(o=o+e.target.rect.bottom-l),(s!==this.rect.x||o!==this.rect.y)&&this.setPosition(s,o)}},new e}),define("engine/core/scheduler",[],function(){"use strict";function e(){}function t(o){if(e.isRunning){var a=.001*(o-s);s=o,a>.05&&(a=.05);for(var l=n.first;l;)l.timeRemaining-=a,l.timeRemaining<0&&(l.method.call(l.context,l,a),l.timeRemaining+=l.interval,l.timeRemaining<0&&(l.timeRemaining=0)),l=l.next;for(l=r.first;l;)l.timeRemaining-=a,l.timeRemaining<0&&r.remove(l),l=l.next;i=window.requestAnimationFrame(t)}}var i,n,r,s=0;return e.isRunning=!1,e.priority={update:1e3,animation:500,render:100},e.limitExecution=function(e,t,i){for(var n=r.first;n;){if(n.method===e&&n.context===t)return;n=n.next}r.addLast({method:e,context:t,timeRemaining:i}),e.apply(t)},e.start=function(){n||(n=new LinkedList),r||(r=new LinkedList),e.isRunning=!0,i=window.requestAnimationFrame(t)},e.stop=function(){e.isRunning=!1,window.cancelAnimationFrame(i)},e.schedule=function(t){null==t.interval&&(t.interval=0),null==t.priority&&(t.priority=e.priority.update),t.timeRemaining=t.interval,n.insertSorted(t,"priority")},e.unschedule=function(e){n.remove(e)},e.unscheduleById=function(e){n.removeBy("id",e)},e}),define("engine/core/linkedList",[],function(){"use strict";function e(){this.first=null}return e.prototype.addFirst=function(e){e.next=this.first,this.first=e},e.prototype.addLast=function(e){if(e.next=null,this.first){for(var t=this.first;t.next;)t=t.next;t.next=e}else this.first=e},e.prototype.insertSorted=function(e,t){if(this.first)if(this.first[t]<e[t])e.next=this.first,this.first=e;else{for(var i=this.first;i.next&&i.next[t]>e[t];)i=i.next;e.next=i.next,i.next=e}else this.first=e},e.prototype.remove=function(e){if(this.first)if(this.first===e)this.first=this.first.next;else for(var t=this.first;t&&t.next;){if(t.next===e){t.next=t.next.next;break}t=t.next}},e.prototype.removeBy=function(e,t){if(this.first)if(this.first[e]===t)this.first=this.first.next;else for(var i=this.first;i&&i.next;){if(i.next[e]===t){i.next=i.next.next;break}i=i.next}},e.prototype.removeFirst=function(){this.first&&(this.first=this.first.next)},e.prototype.removeLast=function(){if(this.first&&this.first.next){for(var e=this.first;e.next.next;)e=e.next;e.next=null}else this.first=null},e}),define("engine/core/rectangle",[],function(){"use strict";function e(e,t,i,n){this.width=i,this.height=n,this.center=new Vector2,this.setPosition(e,t)}return e.prototype.getPosition=function(){return new Vector2(this.left,this.top)},e.prototype.getSimpleRect=function(){return{x:this.left,y:this.top,width:this.width,height:this.height}},e.prototype.getSize=function(){return new Vector2(this.width,this.height)},e.prototype.setCenter=function(e,t){this.center.x=e,this.center.y=t;var i=this.width/2,n=this.height/2;this.left=e-i,this.top=t-n,this.right=e-i,this.bottom=t-n},e.prototype.setPosition=function(e,t){this.left=e,this.top=t,this.right=e+this.width,this.bottom=t+this.height,this.center.x=e+this.width/2,this.center.y=t+this.height/2},e.prototype.setSize=function(e,t){this.width=e,this.height=t,this.right=this.left+this.width,this.bottom=this.top+this.height,this.center.x=this.left+this.width/2,this.center.y=this.top+this.height/2},e.prototype.setSizeFromCenter=function(e,t){this.width=e,this.height=t;var i=this.width/2,n=this.height/2;this.left=this.center.x-i,this.top=this.center.y-n,this.right=this.center.x+i,this.bottom=this.center.y+n},e.prototype.translate=function(e,t){this.setPosition(this.left+e,this.top+t)},e.fromPoints=function(t,i,n,r){var s,o,a,l;return n>t?(s=t,a=n-t):(s=n,a=t-n),r>i?(o=i,l=r-i):(o=r,l=i-r),new e(s,o,a,l)},e}),define("engine/core/utility",[],function(){"use strict";function e(){}e.appendElements=function(e,t){if(Array.isArray(t))for(var i=0;i<t.length;i++)e.appendChild(t[i]);else e.appendChild(t)},e.clamp=function(e,t,i){return t>=e?t:e>=i?i:e},e.findByProperty=function(e,t,i){for(var n=0;n<e.length;n++)if(e[n][t]===i)return e[n]},e.findByProperties=function(e,t){for(var i=0;i<e.length;i++){var n=!0;for(var r in t)if(e[i][r]!==t[r]){n=!1;break}if(n)return e[i]}},e.findParent=function(t,i){for(;t&&!e.matches(t,i);)t=t.parentNode;return t},e.getElementFromTemplate=function(e,t){var i=document.createElement("div");i.innerHTML=e;for(var n=[],r=0;r<i.childNodes.length;r++){var s=i.childNodes[r];8===s.nodeType||3===s.nodeType&&!/S/.test(s.nodeValue)||(n.push(s),t&&t.appendChild(s))}return n.length>1?n:n[0]},e.getSign=function(e){return e?0>e?-1:1:0},e.inherit=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.parent=t.prototype},e.isObjectEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},e.matches=function(e,i){return e[t]?e[t](i):void 0},e.merge=function(){for(var e=arguments[0],t=1;t<arguments.length;t++){var i=arguments[t];if(i)for(var n in i)e[n]=i[n]}return e},e.remove=function(e,t){var i=e.indexOf(t);return i>=0?(e.splice(i,1),!0):void 0},e.removeByProperty=function(e,t,i){for(var n=0;n<e.length;n++)if(e[n][t]===i)return e.splice(n,1)[0]},e.removeByProperties=function(e,t){for(var i=0;i<e.length;i++){var n=!0;for(var r in t)if(e[i][r]!==t[r]){n=!1;break}if(n)return e.splice(i,1)[0]}};for(var t,i=["matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","oMatchesSelector"],n=document.createElement("div"),r=0;r<i.length;r++)if(n[i[r]]){t=i[r];break}return e}),define("engine/core/vector2",[],function(){"use strict";function e(e,t){this.x=e||0,this.y=t||0}return e.prototype.angle=function(e){return null==e?Math.atan2(this.y,this.x):(this.x=Math.cos(e),this.y=Math.sin(e),void 0)},e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},e.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y);return this.x/=e,this.y/=e,e},e.prototype.rotate=function(e){var t=Math.sin(e),i=Math.cos(e);this.x=this.x*i-this.y*t,this.y=this.x*t+this.y*i,this.normalize()},e.add=function(t,i){return new e(t.x+i.x,t.y+i.y)},e.distance=function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},e.distanceSquared=function(e,t){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n},e.divide=function(t,i){return new e(t.x/i,t.y/i)},e.dot=function(e,t){return e.x*t.x+e.y*t.y},e.leftPerpendicular=function(t){return new e(t.y,-t.x)},e.multiply=function(t,i){return new e(t.x*i,t.y*i)},e.normalize=function(t){var i=Math.sqrt(t.x*t.x+t.y*t.y);return new e(t.x/i,t.y/i)},e.reverse=function(t){return new e(-t.x,-t.y)},e.rightPerpendicular=function(t){return new e(-t.y,t.x)},e.subtract=function(t,i){return new e(t.x-i.x,t.y-i.y)},e}),define("engine/game/game",["./viewport","../core/scheduler","../core/linkedList","../core/rectangle","../core/utility","../core/vector2"],function(e,t,i,n,r,s){"use strict";function o(){}return window.LinkedList=i,window.Rectangle=n,window.Utility=r,window.Vector2=s,o.prototype.onReady=function(i){var n=setInterval(function(){"complete"===document.readyState&&(clearInterval(n),t.start(),e.initialize(),i())},20)},o.prototype.setScene=function(t){this.scene&&this.scene.close(),this.scene=t,e.setBounds(t.rect)},new o}),define("engine/data/fileHandler",[],function(){"use strict";var e=window.URL||window.webkitURL;return{loadImage:function(e,t){if(e&&e.type.match("image.*")){var i=new FileReader;return i.onload=function(i){t(e.name,i.target.result)},i.readAsDataURL(e),!0}},loadJSON:function(e,t){if(e){var i=e.name.lastIndexOf("."),n=e.name.substr(i+1);if("json"!==n.toLowerCase())return;var r=new FileReader;return r.onload=function(i){t(e.name,JSON.parse(i.target.result))},r.readAsText(e),!0}},requestJSON:function(e,t){var i=new XMLHttpRequest;i.overrideMimeType("application/json"),i.open("GET",e+".json"),i.onreadystatechange=function(){4===i.readyState&&200===i.status&&t(JSON.parse(i.responseText))},i.send()},saveJSON:function(t,i){Array.isArray(i)||(i=[i]);var n;try{n=e.createObjectURL(new Blob(i,{type:"application/json"}));var r=document.createElement("a");r.href=n,r.target="_target",r.download=t,r.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}))}catch(s){console.log(s)}finally{n&&e.revokeObjectURL(n)}}}}),define("engine/media/imageCache",[],function(){"use strict";function e(e,i){var n={isLoaded:!1,data:new Image,callback:i};return n.data.onload=t.bind(n),n.data.src=e,n}function t(){this.width=this.data.width,this.height=this.data.height,this.isLoaded=!0,this.callback&&(this.callback(this),this.callback=void 0),this.data.onload=void 0}function i(){}var n={};return i.clear=function(){n={}},i.createImage=function(t,i){return e(t,i)},i.getAll=function(){var e=[];for(var t in n)e.push(n[t]);return e},i.getImage=function(e){return n[e]},i.isLoading=function(){for(var e in n)if(n.hasOwnProperty(e)&&!n[e].isLoaded)return!0;return!1},i.loadImage=function(t,i,r){var s=n[t];return s||(s=e(i,r),s.id=t,n[t]=s),s},i.unloadImage=function(e){delete n[e]},i}),define("engine/core/events",[],function(){"use strict";function e(){var e=arguments[0];this.events||(this.events={}),this.events[e]||(this.events[e]=[]);var t,i;arguments.length>2?(t=arguments[1],i=arguments[2]):i=arguments[1],this.events[e].push({context:t,method:i})}function t(){if(this.events){var e=arguments[0];arguments.length>=3?Utility.removeByProperties(this.events[e],{context:arguments[1],method:arguments[2]}):2===arguments.length?Utility.removeByProperty(this.events[e],"method",arguments[1]):this.events[e]=void 0}}function i(){if(this.events){var e=this.events[arguments[0]];if(e&&e.length){Array.prototype.shift.call(arguments);for(var t=0;t<e.length;t++){var i=e[t];i.method.apply(i.context,arguments)}}}}return{register:function(n){n.on=e,n.off=t,n.trigger=i}}}),define("engine/core/inputHandler",["./events"],function(e){"use strict";function t(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)>10}function i(e){var i=null!=e.identifier?e.identifier:"mouse",n=N[i];if(n){var r=n.events[0],s=n.events[n.events.length-1];if(r.targetId===s.targetId){if(n.isDragging){var o=n.events[n.events.length-2],a=o.x-s.x,l=o.y-s.y;M.trigger("drag",e,a,l)}else t(r,s)&&(n.isDragging=!0,M.trigger("dragBegin",s));return!0}}}function n(e){var t=null!=e.identifier?e.identifier:"mouse",i=N[t];if(i){var n=i.events;if(!(n.length>1&&n[0].targetId!==n[n.length-1].targetId)){if(i.isDragging){var r=n.pop(),s=n.pop(),o=r.x-s.x,a=r.y-s.y;M.trigger("dragEnd",e,o,a)}else M.trigger("click",e);delete N[i.id]}}}function r(e,t,i){var n=N[t.identifier],r=N[i.identifier],s=n.events[0],o=r.events[0];if(!(Math.abs(s.timestamp-o.timestamp)>250)){var a=n.events[n.events.length-1],l=r.events[r.events.length-1],h=n.events[n.events.length-2],c=r.events[r.events.length-2],p=Math.abs(h.x-c.x)+Math.abs(h.y-c.y),d=Math.abs(a.x-l.x)+Math.abs(a.y-l.y),u=(a.x+l.x)/2,f=(a.y+l.y)/2,y=document.body.offsetWidth+document.body.offsetHeight,m=5*(d-p)/y;return M.trigger("pinch",e,u,f,m),!0}}function s(e){var t=null!=e.identifier?e.identifier:"mouse",i=N[t];return i||(i={id:t,events:[]},N[t]=i),i.events.push({targetId:e.target.id,timestamp:e.timeStamp,x:e.pageX,y:e.pageY}),i}function o(e){if(P){var t=k[e.keyCode]?M.Keys.Control:e.keyCode;I[t]=!0,v(T,t)||M.trigger("keydown",e)}}function a(e){if(P){var t=k[e.keyCode]?M.Keys.Control:e.keyCode;I[t]=!1,w(T,t)||M.trigger("keyup",e)}}function l(e){P&&m(e.target.id,e.button)&&(s(e),M.trigger("mousedown",e))}function h(e){P&&(N.mouse&&(s(e),i(e)),M.trigger("mousemove",e))}function c(e){P&&(n(e),b(e.target.id,e.button),M.trigger("mouseup",e))}function p(e){if(P){var t=Utility.clamp(e.wheelDelta||-e.detail,-1,1);M.trigger("mousewheel",e,.15*t)}}function d(e){if(P&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];s(i),m(i.target.id,M.Keys.MouseLeft)}e.preventDefault()}function u(e){if(P&&e.touches){for(var t=0;t<e.touches.length;t++)s(e.touches[t]);var n;if(1===e.touches.length?n=i(e.touches[0]):2===e.touches.length&&(n=r(e,e.touches[0],e.touches[1])),!n)for(t=0;t<e.touches.length;t++){var o=e.touches[t],a=N[o.identifier].events[0];b(a.targetId,M.Keys.MouseLeft),m(o.target.id,M.Keys.MouseLeft)}}e.preventDefault()}function f(e){if(P&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];n(i),b(i.target.id,M.Keys.MouseLeft)}e.preventDefault()}function y(e){if(P&&e.changedTouches)for(var t=0;t<e.changedTouches.length;t++){var i=e.changedTouches[t];delete N[i.identifier],b(i.target.id,M.Keys.MouseLeft)}}function m(e,t){return v(R,e)?void 0:(I[t]=!0,v(T,t),!0)}function v(e,t){var i=e[t];if(i){for(var n=0;n<i.length;n++)g(i[n]);return!0}return!1}function g(e){var t=C[e];t&&(E[t.name]=!0,j[t.name]||(j[t.name]=!0,M.trigger(t.name)))}function b(e,t){return w(R,e)?void 0:(I[t]=!1,w(T,t),!0)}function w(e,t){var i=e[t];if(i){for(var n=0;n<i.length;n++)x(i[n]);return!0}return!1}function x(e){var t=C[e];t&&(E[t.name]=!1,j[t.name]=!1)}function S(e,t,i,n){i&&(e[t]?e[t].push(i):e[t]=[i],n&&(n[i]?n[i].push(e.name):n[i]=[e.name]))}function L(e,t,i,n){if(null!=i){e[t]&&Utility.remove(e[t],i);var r=n[i];r&&(Utility.remove(r,e.name),r.length||(n[i]=void 0))}}function M(){}var P=!0,k={17:!0,91:!0,93:!0,224:!0},C={},E={},j={},I={},N={},T={},R={};M.isTouchEnabled="ontouchstart"in window||"onmsgesturechange"in window,M.Keys={MouseLeft:0,MouseMiddle:1,MouseRight:2,Backspace:8,Enter:13,Shift:16,Control:17,Alt:18,Escape:27,Spacebar:32,Left:37,Up:38,Right:39,Down:40,Delete:46,Number0:48,Number1:49,Number2:50,Number3:51,Number4:52,Number5:53,Number6:54,Number7:55,Number8:56,Number9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Tilde:192},M.clearInput=function(){I={},E={},N={},j={}},M.disableInput=function(){P=!1},M.enableInput=function(){P=!0},M.isActive=function(e){return E[e]},M.isKeyDown=function(e){return I[e]},M.registerAction=function(e,t,i){var n=e.name,r=C[n];r||(r={name:n},C[n]=r),S(r,"inputKeys",e.key,T),S(r,"elementIds",e.elementId,R),i&&M.on(n,t,i)},M.unregisterAction=function(e){var t=C[e.name];t&&(L(t,"inputKeys",e.key,T),L(t,"elementIds",e.elementId,R),t.inputKeys&&t.inputKeys.length||t.elementIds&&t.elementIds.length||(C[e.name]=void 0))};var U=function(e){e.preventDefault()},O=function(e){var t=e.target.tagName;t&&"canvas"===t.toLowerCase()&&e.preventDefault()};return window.addEventListener("contextmenu",U,!1),window.addEventListener("MSHoldVisual",U,!1),window.addEventListener("ondragstart",U,!1),window.addEventListener("ondrop",U,!1),window.addEventListener("selectstart",O,!1),window.addEventListener("keydown",o,!1),window.addEventListener("keyup",a,!1),window.addEventListener("mousedown",l,!1),window.addEventListener("mousemove",h,!1),window.addEventListener("mouseup",c,!1),window.addEventListener("mousewheel",p,!1),window.addEventListener("DOMMouseScroll",p,!1),window.addEventListener("blur",M.clearInput),M.isTouchEnabled&&(window.addEventListener("touchstart",d,!1),window.addEventListener("touchmove",u,!1),window.addEventListener("touchend",f,!1),window.addEventListener("touchcancel",y,!1),document.body.msTouchAction="none",document.body.className+=" touch"),e.register(M),M}),define("editor/controls/popup",["engine/core/events"],function(e){"use strict";function t(e,t){this.items=e,this.displayName=t}var i;return t.prototype.close=function(){document.body.removeChild(this.element),i=null,this.trigger("close")},t.prototype.onClick=function(e){var t=Utility.findParent(e.target,".popup-item"),i=Utility.findByProperty(this.itemMap,"element",t);i&&(this.trigger("itemClick",i.itemObject),this.close())},t.prototype.show=function(e,t){i&&i.close(),this.element=document.createElement("div"),this.element.className="popup popup-menu",this.itemMap=[];for(var n=0;n<this.items.length;n++){var r=this.items[n],s=document.createElement("div");s.className="popup-item";var o=document.createElement("span");o.appendChild(document.createTextNode(r[this.displayName])),s.appendChild(o),this.element.appendChild(s),this.itemMap.push({itemObject:r,element:s})}document.body.appendChild(this.element);var a=this.element.offsetWidth,l=this.element.offsetHeight,h=document.body.clientWidth,c=document.body.clientHeight;return this.left=e-a/2,this.top=t+16,this.element.style.top=Utility.clamp(this.top,8,c-l-8)+"px",this.element.style.left=Utility.clamp(this.left,8,h-a-8)+"px",this.element.style.maxWidth=h+"px",this.element.style.maxHeight=c+"px",this.element.addEventListener("click",this.onClick.bind(this),!1),i=this,this},window.addEventListener("mousedown",function(e){i&&!Utility.findParent(e.target,".popup")&&i.close()},!1),e.register(t.prototype),t}),define("editor/controls/propertiesSection",["engine/core/events"],function(e){"use strict";function t(){this.element=document.createElement("div"),this.element.className="properties",this.element.addEventListener("change",this.onElementChanged.bind(this),!1),this.properties=[],this.config={rect:{isRequired:!0,validate:i}}}function i(e,t){var i=e.valueProperty,n=parseFloat(t);return n!=t&&(n=i.value),("width"===i.key||"height"===i.key)&&(n=Math.round(n),1>n&&(n=i.value)),n}return t.prototype.addValues=function(e){for(var t=this.getPropertiesFromObject(e),i=document.createDocumentFragment(),n=0;n<t.length;n++){var r=document.createElement("div");r.className="property-element";var s=document.createElement("input");s.className="property-key",s.type="text";var o=t[n];s.value=o.key,o.element=s;var a=this.config[o.key];a&&(s.disabled=a.isRequired);var l=document.createElement("div");l.className="property-value";for(var h=o.values.length,c=Math.floor((140-(h-1))/h)+"px",p=0;h>p;p++){var d=document.createElement("input");d.className="property-value-item",d.type="text",d.style.width=c;var u=o.values[p];d.value=u.value,u.element=d,l.appendChild(d)}r.appendChild(s),r.appendChild(l),i.appendChild(r)}this.element.appendChild(i),this.properties.push.apply(this.properties,t)},t.prototype.constrainValue=function(e,t){var i=this.config[e.property.key];if(i)i.validate?t=i.validate(e,t):i.isNumeric&&(t=parseFloat(t)||e.valueProperty.value,i.minValue&&(t=Math.max(t,i.minValue)),i.maxValue&&(t=Math.min(t,i.maxValue)));else{var n=parseFloat(t);n==t&&(t=n)}return t},t.prototype.getPropertyForElement=function(e){for(var t=0;t<this.properties.length;t++){var i=this.properties[t];if(i.element===e)return{property:i};var n=Utility.findByProperty(i.values,"element",e);if(n)return{property:i,valueProperty:n}}},t.prototype.getPropertiesFromObject=function(e){var t=[];for(var i in e)if(e.hasOwnProperty(i)&&(!this.config.exclusions||!this.config.exclusions[i])){var n={key:i,values:[]};t.push(n);var r=e[i];if("object"==typeof r)for(var s in r)r.hasOwnProperty(s)&&n.values.push({key:s,value:r[s]});else n.values.push({value:r})}return t},t.prototype.onElementChanged=function(e){var t=this.getPropertyForElement(e.target);if(t){var i,n;if(t.valueProperty?(i=this.constrainValue(t,e.target.value),n=t.valueProperty.value,t.valueProperty.value=i):(i=e.target.value.replace(" ",""),n=t.property.key,i?t.property.key=i:(Utility.remove(this.properties,t.property),this.element.removeChild(Utility.findParent(e.target,".property-element")))),n!==i)if(this.trigger("propertyChange",t.property,t.valueProperty),e.target.value=i,t.valueProperty)t.valueProperty.key?this.object[t.property.key][t.valueProperty.key]=i:this.object[t.property.key]=i;else{var r=this.object[n];delete this.object[n],i&&(this.object[i]=r)}e.stopPropagation()}},t.prototype.addNewProperty=function(){this.object.key="value",this.addValues({key:"value"})},t.prototype.clear=function(){for(this.properties.length=0;this.element.firstChild;)this.element.removeChild(this.element.firstChild)},t.prototype.setConfig=function(e){Utility.merge(this.config,e)},t.prototype.setObject=function(e){this.clear(),this.object=e,this.addValues(e)},e.register(t.prototype),t}),define("engine/spatial/tileMap",[],function(){"use strict";function e(e,t,i,n){this.width=e,this.height=t,this.tileSize=i,this.tiles=n===!1?[]:new Uint8Array(new ArrayBuffer(e*t))}return e.prototype.getTile=function(e,t){return this.tiles[e+t*this.width]},e.prototype.getTileAtIndex=function(e){return this.tiles[e]},e.prototype.getTileAtPosition=function(e,t){return e=Math.floor(e/this.tileSize),t=Math.floor(t/this.tileSize),this.tiles[e+t*this.width]},e.prototype.isInBounds=function(e,t){return e>=0&&t>=0&&e<this.width&&t<this.height},e.prototype.setTile=function(e,t,i){this.tiles[e+t*this.width]=i},e.prototype.setTileAtIndex=function(e,t){this.tiles[e]=t},e.prototype.setTileAtPosition=function(e,t,i){e=Math.floor(e/this.tileSize),t=Math.floor(t/this.tileSize),this.tiles[e+t*this.width]=i},e}),define("engine/data/webStorage",["../core/events"],function(e){"use strict";function t(){}var i;return t.setSaveInterval=function(e){i&&clearInterval(i),i=setInterval(function(){t.trigger("save")},1e3*e)},t.getData=function(e){if(window.localStorage){var t=window.localStorage.getItem(e);if(t)return JSON.parse(t)}},t.deleteData=function(){if(window.localStorage)for(var e=0;e<arguments.length;e++)window.localStorage.removeItem(arguments[e])},t.hasData=function(){if(!window.localStorage)return!1;for(var e=0;e<arguments.length;e++)if(!window.localStorage.getItem(arguments[e]))return!1;return!0},t.setData=function(e,t){if(window.localStorage)try{window.localStorage.setItem(e,JSON.stringify(t))}catch(i){}},window.localStorage&&window.addEventListener("beforeunload",function(){t.trigger("save")},!1),e.register(t),t}),define("text",["module"],function(e){"use strict";var t,i,n,r,s,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],a=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,l=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,h="undefined"!=typeof location&&location.href,c=h&&location.protocol&&location.protocol.replace(/\:/,""),p=h&&location.hostname,d=h&&(location.port||void 0),u={},f=e.config&&e.config()||{};return t={version:"2.0.9",strip:function(e){if(e){e=e.replace(a,"");var t=e.match(l);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:f.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){i=o[t];try{e=new ActiveXObject(i)}catch(n){}if(e){o=[i];break}}return e},parseName:function(e){var t,i,n,r=!1,s=e.indexOf("."),o=0===e.indexOf("./")||0===e.indexOf("../");return-1!==s&&(!o||s>1)?(t=e.substring(0,s),i=e.substring(s+1,e.length)):t=e,n=i||t,s=n.indexOf("!"),-1!==s&&(r="strip"===n.substring(s+1),n=n.substring(0,s),i?i=n:t=n),{moduleName:t,ext:i,strip:r}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,i,n,r){var s,o,a,l=t.xdRegExp.exec(e);return l?(s=l[2],o=l[3],o=o.split(":"),a=o[1],o=o[0],!(s&&s!==i||o&&o.toLowerCase()!==n.toLowerCase()||(a||o)&&a!==r)):!0},finishLoad:function(e,i,n,r){n=i?t.strip(n):n,f.isBuild&&(u[e]=n),r(n)},load:function(e,i,n,r){if(r.isBuild&&!r.inlineText)return n(),void 0;f.isBuild=r.isBuild;var s=t.parseName(e),o=s.moduleName+(s.ext?"."+s.ext:""),a=i.toUrl(o),l=f.useXhr||t.useXhr;!h||l(a,c,p,d)?t.get(a,function(i){t.finishLoad(e,s.strip,i,n)},function(e){n.error&&n.error(e)}):i([o],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,n)})},write:function(e,i,n){if(u.hasOwnProperty(i)){var r=t.jsEscape(u[i]);n.asModule(e+"!"+i,"define(function () { return '"+r+"';});\n")}},writeFile:function(e,i,n,r,s){var o=t.parseName(i),a=o.ext?"."+o.ext:"",l=o.moduleName+a,h=n.toUrl(o.moduleName+a)+".js";t.load(l,n,function(){var i=function(e){return r(h,e)};i.asModule=function(e,t){return r.asModule(e,h,t)},t.write(e,l,i,s)},s)}},"node"===f.env||!f.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]?(i=require.nodeRequire("fs"),t.get=function(e,t,n){try{var r=i.readFileSync(e,"utf8");0===r.indexOf("﻿")&&(r=r.substring(1)),t(r)}catch(s){n(s)}}):"xhr"===f.env||!f.env&&t.createXhr()?t.get=function(e,i,n,r){var s,o=t.createXhr();if(o.open("GET",e,!0),r)for(s in r)r.hasOwnProperty(s)&&o.setRequestHeader(s.toLowerCase(),r[s]);f.onXhr&&f.onXhr(o,e),o.onreadystatechange=function(){var t,r;4===o.readyState&&(t=o.status,t>399&&600>t?(r=new Error(e+" HTTP status: "+t),r.xhr=o,n(r)):i(o.responseText),f.onXhrComplete&&f.onXhrComplete(o,e))},o.send(null)}:"rhino"===f.env||!f.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?t.get=function(e,t){var i,n,r="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),a=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),r)),l="";try{for(i=new java.lang.StringBuffer,n=a.readLine(),n&&n.length()&&65279===n.charAt(0)&&(n=n.substring(1)),null!==n&&i.append(n);null!==(n=a.readLine());)i.append(o),i.append(n);l=String(i.toString())}finally{a.close()}t(l)}:("xpconnect"===f.env||!f.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(n=Components.classes,r=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in n,t.get=function(e,t){var i,o,a,l={};s&&(e=e.replace(/\//g,"\\")),a=new FileUtils.File(e);try{i=n["@mozilla.org/network/file-input-stream;1"].createInstance(r.nsIFileInputStream),i.init(a,1,0,!1),o=n["@mozilla.org/intl/converter-input-stream;1"].createInstance(r.nsIConverterInputStream),o.init(i,"utf-8",i.available(),r.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),o.readString(i.available(),l),o.close(),i.close(),t(l.value)}catch(h){throw new Error((a&&a.path||"")+": "+h)}}),t}),define("text!editor/templates/mainPanel.html",[],function(){return'<div class="main-panel">\r\n    <div data-name="level-panel">\r\n        <div class="header">\r\n            <label>Level</label>\r\n            <div class="header-button-panel">\r\n                <div class="icon add-icon" title="Add property"></div>\r\n            </div>\r\n        </div>\r\n        <div class="contents">\r\n            <input data-name="saveFileName" type="text" placeholder="File name"/>\r\n            <button data-name="new">New</button>\r\n            <button data-name="save">Save</button>\r\n            <input type="file" data-name="load"/>\r\n        </div>\r\n    </div>\r\n    <div data-name="grid-panel">\r\n        <div class="header">\r\n            <label>Grid</label>\r\n            <div class="header-button-panel">\r\n                <div class="icon visibility-icon" title="Toggle grid visibility"></div>\r\n            </div>\r\n        </div>\r\n        <div class="contents"></div>\r\n    </div>\r\n    <div data-name="layer-panel">\r\n        <div class="header">\r\n            <label>Layers</label>\r\n            <div class="header-button-panel">\r\n                <div class="icon up-icon" title="Move layer up"></div>\r\n                <div class="icon down-icon" title="Move layer down"></div>\r\n                <div class="icon add-icon" title="Add layer"></div>\r\n            </div>\r\n        </div>\r\n        <div class="layer-item-panel"></div>\r\n    </div>\r\n    <div class="properties-panel"></div>\r\n</div>'}),define("text!editor/templates/layer.html",[],function(){return'<div class="layer">\r\n    <div class="icon visibility-icon visible" title="Toggle layer visibility"></div>\r\n    <div class="layer-title-container">\r\n        <input type="text"/>\r\n    </div>\r\n    <div class="icon remove-icon" title="Remove layer"></div>\r\n</div>'}),define("editor/core/mainPanel",["Editor","text!../templates/mainPanel.html","text!../templates/layer.html"],function(e,t,i){"use strict";function n(){var i={isVisible:!1,rect:{x:0,y:0,width:64,height:64},tileSize:64};e.getGridSettings=function(){return i},this.grid=i,this.layers=[],document.body.insertAdjacentHTML("beforeend",t),this.element=document.body.querySelector(".main-panel"),this.layerItemPanel=this.element.querySelector(".layer-item-panel"),this.propertiesPanel=this.element.querySelector(".properties-panel"),this.properties={},this.propertiesSection=new e.PropertiesSection,this.propertiesSection.setObject(this.properties),this.initialize()}function r(e,t){e.isVisible=!e.isVisible,e.isVisible?t.classList.add("visible"):t.classList.remove("visible")}return n.prototype.initialize=function(){this.element.addEventListener("click",this.onClick.bind(this));var t=this.element.querySelector('[data-name="level-panel"');t.querySelector('[data-name="new"]').addEventListener("click",this.clear.bind(this),!1),t.querySelector('[data-name="load"]').addEventListener("change",this.onLoad.bind(this),!1),t.querySelector('[data-name="save"]').addEventListener("click",this.onSave.bind(this),!1),t.querySelector(".add-icon").addEventListener("click",this.propertiesSection.addNewProperty.bind(this.propertiesSection),!1),t.querySelector(".contents").appendChild(this.propertiesSection.element);
var i=this.element.querySelector('[data-name="layer-panel"');i.querySelector(".add-icon").addEventListener("click",this.onAddLayer.bind(this),!1),i.querySelector(".up-icon").addEventListener("click",this.onMoveLayerUp.bind(this),!1),i.querySelector(".down-icon").addEventListener("click",this.onMoveLayerDown.bind(this),!1);var n=this.element.querySelector('[data-name="grid-panel"');n.querySelector(".visibility-icon").addEventListener("click",this.onToggleGridVisibility.bind(this),!1);var r=new e.PropertiesSection;r.setConfig({exclusions:{isVisible:!0},tileSize:{isRequired:!0,minValue:1}}),r.setObject(this.grid),n.querySelector(".contents").appendChild(r.element)},n.prototype.onAddLayer=function(t){var i=e.Plugins.layerTypes;i&&i.length&&(this.popup=new e.Popup(i,"type").show(t.pageX,t.pageY),this.popup.on("close",this,function(){this.popup=null}.bind(this)),this.popup.on("itemClick",this,function(e){this.createLayerFromType(e)}.bind(this)))},n.prototype.onMoveLayerUp=function(){if(this.layers.length>1){var e=this.layers.indexOf(this.selectedLayer);e>0&&(this.layers.splice(e-1,0,this.layers.splice(e,1)[0]),this.layerItemPanel.insertBefore(this.selectedLayer.element,this.selectedLayer.element.previousSibling))}},n.prototype.onMoveLayerDown=function(){if(this.layers.length>1){var e=this.layers.indexOf(this.selectedLayer);e<this.layers.length-1&&(this.layers.splice(e+1,0,this.layers.splice(e,1)[0]),this.layerItemPanel.insertBefore(this.selectedLayer.element.nextSibling,this.selectedLayer.element))}},n.prototype.createLayer=function(e){var t={object:e,element:Utility.getElementFromTemplate(i,this.layerItemPanel),isVisible:null!=e.isVisible?e.isVisible:!0};t.title=t.element.querySelector("input"),t.title.value=e.name,this.layers.push(t),this.selectedLayer||this.selectLayer(t)},n.prototype.createLayerFromType=function(e){var t=new e;t.type=e.type,this.createLayer(t)},n.prototype.removeLayer=function(e){this.layerItemPanel.removeChild(e.element),Utility.remove(this.layers,e),this.selectedLayer===e&&this.selectLayer(this.layers[0])},n.prototype.selectLayer=function(e){if(this.selectedLayer!==e){for(this.selectedLayer&&(this.selectedLayer.object.isSelected=!1,this.selectedLayer.element.classList.remove("selected"),this.selectedLayer.object.onDeselected&&this.selectedLayer.object.onDeselected()),this.selectedLayer=e;this.propertiesPanel.firstChild;)this.propertiesPanel.removeChild(this.propertiesPanel.firstChild);if(this.selectedLayer){if(this.selectedLayer.object.isSelected=!0,this.selectedLayer.element.classList.add("selected"),this.selectedLayer.object.getPanel){var t=this.selectedLayer.object.getPanel();t&&Utility.appendElements(this.propertiesPanel,t)}this.selectedLayer.object.onSelected&&this.selectedLayer.object.onSelected()}}},n.prototype.updateLayerNames=function(){for(var e=0;e<this.layers.length;e++){var t=this.layers[e];t.object.name=t.title.value}},n.prototype.onToggleGridVisibility=function(e){r(this.grid,e.target)},n.prototype.clear=function(){for(this.layers.length=0,this.selectLayer(null),this.propertiesSection.clear();this.layerItemPanel.firstChild;)this.layerItemPanel.removeChild(this.layerItemPanel.firstChild)},n.prototype.loadData=function(t,i){this.clear();var n=this.element.querySelector('[data-name="saveFileName"]');if(n.value=t.substr(0,t.lastIndexOf(".")),i.properties&&(this.properties=i.properties,this.propertiesSection.setObject(this.properties)),i.layers)for(var r=0;r<i.layers.length;r++){var s=i.layers[r],o=Utility.findByProperty(e.Plugins.layerTypes,"type",s.type);if(o){var a=new o;a.name=s.name,a.type=s.type,a.deserialize(s),this.createLayer(a)}}},n.prototype.onClick=function(e){var t=Utility.findParent(e.target,".layer");if(t){var i=Utility.findByProperty(this.layers,"element",t);Utility.matches(e.target,".remove-icon")?this.removeLayer(i):(this.selectLayer(i),Utility.matches(e.target,".visibility-icon")&&r(i,e.target))}e.stopPropagation()},n.prototype.onLoad=function(t){e.FileHandler.loadJSON(t.target.files[0],this.loadData.bind(this))},n.prototype.onSave=function(t){var i=this.element.querySelector('[data-name="saveFileName"]').value||"level",n={layers:[]};Utility.isObjectEmpty(this.properties)||(n.properties=this.properties),this.updateLayerNames();for(var r=0;r<this.layers.length;r++){var s=this.layers[r].object;n.layers.push(Utility.merge({name:s.name,type:s.type},s.serialize()))}e.FileHandler.saveJSON(i+".json",JSON.stringify(n)),t.stopPropagation()},n}),define("editor/core/editorInterface",["Editor","engine/game/viewport","./mainPanel"],function(e,t,i){"use strict";function n(){e.Scheduler.schedule({context:this,method:this.draw,priority:e.Scheduler.priority.render}),e.Scheduler.schedule({context:this,method:this.update}),e.InputHandler.on("mousedown",this,this.forwardEvent.bind(this,"onMouseDown")),e.InputHandler.on("mousemove",this,this.forwardEvent.bind(this,"onMouseMove")),e.InputHandler.on("mouseup",this,this.forwardEvent.bind(this,"onMouseUp")),e.InputHandler.on("click",this,this.forwardEvent.bind(this,"onClick")),e.InputHandler.on("keydown",this,this.forwardEvent.bind(this,"onKeyDown")),e.InputHandler.on("keyup",this,this.forwardEvent.bind(this,"onKeyUp")),e.InputHandler.on("drag",this.onDrag.bind(this)),e.InputHandler.on("pinch",this.onPinch.bind(this)),e.InputHandler.on("mousewheel",this.onMouseWheel.bind(this)),this.mainPanel=new i,this.loadResources()}function r(e){return e.target.tagName&&"canvas"===e.target.tagName.toLowerCase()}return n.prototype.update=function(e,i){t.update(i)},n.prototype.draw=function(e,i){for(var n=this.mainPanel.layers.length-1;n>=0;n--){var r=this.mainPanel.layers[n];r.isVisible&&r.object.draw&&r.object.draw(t,i)}var s=this.mainPanel.grid;if(s.isVisible){var o=this.mainPanel.grid.tileSize,a=Math.max(0,Math.floor(t.rect.left/o)),l=Math.max(0,Math.floor(t.rect.top/o)),h=Math.min(s.rect.width,Math.ceil(t.rect.right/o)),c=Math.min(s.rect.height,Math.ceil(t.rect.bottom/o));t.context.strokeStyle="blue",t.context.lineWidth=.5;for(var p=Math.floor((l*o-t.rect.top)*t.scale),d=Math.floor((c*o-t.rect.top)*t.scale),u=a;h>=u;u++){var f=Math.floor((u*o-t.rect.left)*t.scale);t.context.beginPath(),t.context.moveTo(f,p),t.context.lineTo(f,d),t.context.stroke()}for(var y=Math.floor((a*o-t.rect.left)*t.scale),m=Math.floor((h*o-t.rect.left)*t.scale),v=l;c>=v;v++){var g=Math.floor((v*o-t.rect.top)*t.scale);t.context.beginPath(),t.context.moveTo(y,g),t.context.lineTo(m,g),t.context.stroke()}}},n.prototype.forwardEvent=function(e,i){if(this.mainPanel.selectedLayer&&this.mainPanel.selectedLayer.isVisible&&r(i)){var n=this.mainPanel.selectedLayer.object;n[e]&&n[e](i,t)}},n.prototype.onDrag=function(e,i,n){2===e.which&&r(e)&&t.move(i/t.scale,n/t.scale)},n.prototype.onPinch=function(e,i,n,s){r(e)&&t.setScale(t.scale+s)},n.prototype.onMouseWheel=function(e,i){e.target.tagName&&"canvas"===e.target.tagName.toLowerCase()&&t.setScale(t.scale+i)},n.prototype.loadResources=function(){var t=e.Plugins.resources;if(t)for(var i=0;i<t.length;i++){var n=t[i],r=n.substr(0,n.lastIndexOf("."));e.ImageCache.loadImage(r,"resources/"+n)}},n}),define("Editor",["engine/data/fileHandler","engine/media/imageCache","engine/core/inputHandler","editor/controls/popup","editor/controls/propertiesSection","engine/core/scheduler","engine/spatial/tileMap","engine/data/webStorage"],function(e,t,i,n,r,s,o,a){"use strict";return{FileHandler:e,InputHandler:i,ImageCache:t,Popup:n,PropertiesSection:r,Scheduler:s,TileMap:o,WebStorage:a}}),require(["engine/game/game","editor/core/editorInterface"],function(e,t){"use strict";e.onReady(function(){require(["Editor","Plugins"],function(i,n){i.Plugins=n,e.setScene(new t)})})}),define("editor/main",function(){});